---
title: "Diabetes example"
author: "Kevin Wang"
date: "22/08/2018"
output:
  html_document:
    self_contained: no
---


# Introduction 

```{r}
library(APES)
library(glmnet)
library(mplot)
library(tidyverse)
library(directlabels)
library(plotly)
```

## Loading data

We will illustrate the utility of the APES method on the diabetes data from the `mplot` package. We will dichromise the response variable y by spliting it at the median. 



```{r}
diabetes = mplot::diabetes
x = diabetes %>% dplyr::select(age:glu) %>% as.matrix() %>% cbind(RV = rnorm(nrow(diabetes))) %>% scale
y = ifelse(diabetes$y > median(diabetes$y), 1L, 0L)
dim(x)
length(y)
```


# Running APES on diabetes data


## Using the leaps estimator 
```{r}
# fullModel = glm.fit(x = x, y = y, family = binomial(link = "logit"))
fullModel = glm(y ~ x, family = "binomial")

apes_logit_leaps = apes_logit(
  x = x,
  y = y,
  Pi = fullModel$fitted.values,
  k = 1:ncol(x), 
  estimator = "leaps")

apes_logit_leaps$selectedModelBeta
```


# Running Lasso on diabetes data
```{r}
lasso_logit = glmnet::cv.glmnet(x = x,
                                y = y)
lasso_logit_coef = coef(lasso_logit, s = "lambda.min")
rownames(lasso_logit_coef)[as.matrix(lasso_logit_coef != 0)]
```


# Bootstrapping using leaps version 
```{r, results = 'hide'}
t1 = Sys.time()
listResult = APES::boot_apes_logit(
  x = x,
  y = y,
  Pi = fullModel$fitted.values,
  k = 1:ncol(x), 
  estimator = "leaps",
  nBoot = 1000)
t2 = Sys.time()
t2 - t1
```


## Plotting
```{r}
viPlotResult = APES::viPlot_apes(listResult)
viPlotResult$viPlot
viTilePlotResult = APES::viTilePlot_apes(listResult)
viTilePlotResult
```


# Compare against mplot

```{r}
plotly::ggplotly(
  viPlotResult$viPlot + 
  theme_classic(18) 
)
```


```{r, results = "asis", message=FALSE}
t3 = Sys.time()
mplotResult = mplot::vis(
  mf = fullModel, 
  B = 1000,
  redundant = FALSE)
t4 = Sys.time()
t4 - t3
# plot(mplotResult, which = "vip", interactive = TRUE)
plot(mplotResult, which = "vip", interactive = TRUE, tag = "chart")
```

# Session Info
```{r}
sessionInfo()
```

